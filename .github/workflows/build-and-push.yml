name: Build and Push (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (dev or prod)'
        required: true
        type: string
      force_rebuild:
        description: 'Force rebuild without cache'
        required: false
        type: boolean
        default: false
    outputs:
      image_tag:
        description: 'Built image tag'
        value: ${{ jobs.build-and-push-api.outputs.image_tag }}

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  build-and-push-api:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        run: |
          az acr login --name ${{ vars.CONTAINER_REGISTRY_NAME }}

      - name: Set build flags
        id: build-flags
        run: |
          if [[ "${{ inputs.force_rebuild }}" == "true" ]]; then
            echo "cache_flags=--no-cache --pull" >> "$GITHUB_OUTPUT"
            echo "use_cache=false" >> "$GITHUB_OUTPUT"
          else
            echo "cache_flags=" >> "$GITHUB_OUTPUT"
            echo "use_cache=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Pull existing image for cache warming
        if: steps.build-flags.outputs.use_cache == 'true'
        continue-on-error: true
        run: |
          docker pull ${{ vars.CONTAINER_REGISTRY_ENDPOINT }}/api:${{ inputs.environment }}-latest || true

      - name: Build and Push API Image
        id: build
        run: |
          REGISTRY=${{ vars.CONTAINER_REGISTRY_ENDPOINT }}
          SHORT_SHA=${GITHUB_SHA:0:7}
          IMAGE_TAG="${{ inputs.environment }}-${SHORT_SHA}"
          
          CACHE_FROM=""
          if [[ "${{ steps.build-flags.outputs.use_cache }}" == "true" ]]; then
            CACHE_FROM="--cache-from=${REGISTRY}/api:${{ inputs.environment }}-latest"
          fi
          
          docker build -f api/Dockerfile \
            ${{ steps.build-flags.outputs.cache_flags }} \
            $CACHE_FROM \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            --label git-commit=${GITHUB_SHA} \
            --label git-branch=${{ github.ref_name }} \
            --label environment=${{ inputs.environment }} \
            -t ${REGISTRY}/api:${IMAGE_TAG} \
            -t ${REGISTRY}/api:${{ inputs.environment }}-latest .
          
          docker push ${REGISTRY}/api:${IMAGE_TAG}
          docker push ${REGISTRY}/api:${{ inputs.environment }}-latest
          
          echo "image_tag=${IMAGE_TAG}" >> "$GITHUB_OUTPUT"

      - name: Start PostgreSQL for Smoke Test
        run: |
          docker run --rm -d --name smoke-test-db \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=learntocloud \
            -p 5432:5432 \
            postgres:16-alpine
          sleep 5

      - name: Smoke Test API Image
        run: |
          REGISTRY=${{ vars.CONTAINER_REGISTRY_ENDPOINT }}
          
          docker run --rm -d --name smoke-test -p 8000:8000 \
            --link smoke-test-db:db \
            -e DATABASE_URL=postgresql+asyncpg://postgres:postgres@db:5432/learntocloud \
            -e CLERK_SECRET_KEY=test \
            -e LLM_API_KEY=test \
            ${REGISTRY}/api:${{ steps.build.outputs.image_tag }}
          
          sleep 10
          curl -f http://localhost:8000/health || (docker logs smoke-test && exit 1)
          docker stop smoke-test
          docker stop smoke-test-db

      - name: Install Trivy
        run: |
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update && sudo apt-get install -y trivy

      - name: Security Scan API Image
        run: |
          REGISTRY=${{ vars.CONTAINER_REGISTRY_ENDPOINT }}
          
          echo "Running Trivy security scan (blocks on HIGH/CRITICAL findings)..."
          trivy image --ignore-unfixed --exit-code 1 --severity HIGH,CRITICAL \
            ${REGISTRY}/api:${{ steps.build.outputs.image_tag }}

  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          VITE_API_URL: ""
          VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}

      - name: Copy staticwebapp.config.json
        run: cp frontend/staticwebapp.config.json frontend/dist/

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist-${{ github.sha }}
          path: frontend/dist/
          retention-days: 7
