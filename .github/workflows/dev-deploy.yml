name: Deploy to Dev (Ephemeral)

on:
  push:
    branches: [dev]
    paths-ignore:
      - 'infra/**'
      - 'docs/**'
  pull_request:
    branches: [dev]
  workflow_call:
    inputs:
      force_rebuild:
        description: 'Force rebuild without cache (for weekly security rebuilds)'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-dev
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

defaults:
  run:
    shell: bash

jobs:
  # ============================================================
  # STAGE 1: Validation (Lint & Test)
  # ============================================================
  lint-and-test:
    uses: ./.github/workflows/lint-and-test.yml

  # ============================================================
  # STAGE 2: Infrastructure
  # ============================================================
  create-infra:
    needs: lint-and-test
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    uses: ./.github/workflows/infra-apply.yml
    with:
      environment: dev
    secrets: inherit

  # ============================================================
  # STAGE 3: Build
  # ============================================================
  build-and-push:
    needs: [lint-and-test, create-infra]
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    uses: ./.github/workflows/build-and-push.yml
    with:
      environment: dev
      force_rebuild: ${{ inputs.force_rebuild || false }}
    secrets: inherit

  # ============================================================
  # STAGE 4: Deployment
  # ============================================================
  deploy:
    needs: build-and-push
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup Azure environment
        uses: ./.github/actions/setup-azure-env
        with:
          environment: dev

      - name: Deploy API
        uses: ./.github/actions/deploy-api
        with:
          environment: dev
          image-tag: ${{ needs.build-and-push.outputs.image_tag }}

      - name: Download frontend build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist-${{ github.sha }}
          path: frontend/dist/

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOYMENT_TOKEN_DEV }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "frontend/dist"
          output_location: ""
          skip_app_build: true
          skip_api_build: true

  # ============================================================
  # STAGE 5: Post-Deploy Tests (Placeholders)
  # ============================================================
  post-deploy-tests:
    needs: deploy
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Placeholder - Integration tests
        run: |
          echo "‚ö†Ô∏è  Integration tests not yet implemented."
          echo "TODO: Add integration test suite against deployed dev environment."
          echo "Note: Include tests against Azure PostgreSQL in dev."

      - name: Placeholder - E2E tests
        run: |
          echo "‚ö†Ô∏è  E2E tests not yet implemented."
          echo "TODO: Add Playwright/Cypress tests against deployed dev environment."

      - name: Placeholder - Performance tests
        run: |
          echo "‚ö†Ô∏è  Performance tests not yet implemented."
          echo "TODO: Add k6/Locust tests against deployed dev environment."

  # ============================================================
  # STAGE 5: Approval & Teardown
  # ============================================================
  approval-gate:
    needs: post-deploy-tests
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    runs-on: ubuntu-latest
    timeout-minutes: 720  # 12 hours
    environment:
      name: dev-teardown
    steps:
      - name: Awaiting manual approval to destroy dev environment
        run: |
          echo "‚úÖ Dev environment is live and ready for testing"
          echo "üîó Review deployment details above"
          echo ""
          echo "‚è≥ Waiting for approval to destroy dev infrastructure..."
          echo "‚è∞ Timeout: 12 hours from workflow start"
          echo ""
          echo "Once approved, the entire dev infrastructure will be destroyed to save costs."

  # Destroy ephemeral dev infrastructure after manual approval via reusable infra workflow
  destroy-infra:
    needs: approval-gate
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    uses: ./.github/workflows/infra-destroy.yml
    with:
      environment: dev
    secrets: inherit
