name: Deploy to Dev

on:
  push:
    branches: [dev]
    paths-ignore:
      - 'infra/**'
      - 'docs/**'
  pull_request:
    branches: [dev]
  workflow_call:
    inputs:
      force_rebuild:
        description: 'Force rebuild without cache (for weekly security rebuilds)'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-dev
  cancel-in-progress: false

permissions:
  contents: read

defaults:
  run:
    shell: bash

env:
  AZURE_ENV_NAME: dev
  AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP_DEV }}
  TF_VAR_environment: dev
  TF_VAR_location: ${{ vars.AZURE_LOCATION }}
  TF_VAR_frontend_custom_domain: ${{ vars.FRONTEND_CUSTOM_DOMAIN_DEV }}
  ARM_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
  ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
  ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

jobs:
  # On PR: Run lint and test
  lint-and-test-pr:
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/lint-and-test.yml

  # On push or workflow_call: Lint, test, build, scan, and deploy
  lint-and-test:
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    uses: ./.github/workflows/lint-and-test.yml

  build-and-push:
    needs: lint-and-test
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    uses: ./.github/workflows/build-and-push.yml
    with:
      environment: dev
      force_rebuild: ${{ inputs.force_rebuild || false }}
    secrets: inherit

  deploy:
    needs: build-and-push
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy API Container App
        run: |
          FRONTEND_URL="https://${{ vars.FRONTEND_URL_DEV }}"
          
          az containerapp update \
            --name ${{ vars.CONTAINER_APP_NAME_DEV }} \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP_DEV }} \
            --image ${{ vars.CONTAINER_REGISTRY_ENDPOINT }}/api:${{ needs.build-and-push.outputs.image_tag }} \
            --set-env-vars FRONTEND_URL="$FRONTEND_URL" RUN_MIGRATIONS_ON_STARTUP=true

      - name: Wait for API readiness
        run: |
          set -euo pipefail

          READY_URL="https://${{ vars.API_URL_DEV }}/ready"
          echo "Waiting for API readiness at: $READY_URL"

          for i in {1..30}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$READY_URL" || true)
            if [[ "$code" == "200" ]]; then
              echo "API is ready."
              exit 0
            fi

            echo "Attempt $i: API not ready yet (HTTP $code); retrying in 10s..."
            sleep 10
          done

          echo "API did not become ready within the expected time."
          exit 1

      - name: Download frontend build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist-${{ github.sha }}
          path: frontend/dist/

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOYMENT_TOKEN_DEV }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "frontend/dist"
          output_location: ""
          skip_app_build: true
          skip_api_build: true

  integration-tests:
    needs: [build-and-push, deploy]
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      # TODO: Implement integration tests
      # - name: Run API integration tests
      #   run: |
      #     API_URL="${{ needs.get-terraform-outputs.outputs.api_url }}"
      #     # Run integration test suite against deployed dev environment
      #     # pytest tests/integration/ --api-url=$API_URL

      # TODO: Implement smoke tests
      # - name: Run smoke tests
      #   run: |
      #     API_URL="${{ needs.get-terraform-outputs.outputs.api_url }}"
      #     # Test critical user paths
      #     # curl -f $API_URL/api/health
      #     # curl -f $API_URL/api/users/me

      # TODO: Implement E2E tests
      # - name: Run E2E tests
      #   run: |
      #     FRONTEND_URL="${{ needs.get-terraform-outputs.outputs.frontend_url }}"
      #     # Run Playwright/Cypress tests
      #     # npm run test:e2e -- --base-url=$FRONTEND_URL

      - name: Placeholder - Tests not yet implemented
        run: |
          echo "⚠️  Integration, smoke, and E2E tests are not yet implemented."
          echo "TODO: Add test suites before promoting to production."
          echo "Deployment to dev completed successfully."
