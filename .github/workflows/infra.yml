name: Apply Infra

on:
  push:
    branches: [dev, main]
    paths:
      - 'infra/**'
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (dev or prod)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (dev or prod)'
        required: true
        type: choice
        options:
          - dev
          - prod
      apply:
        description: "Apply Terraform changes"
        type: boolean
        default: true

concurrency:
  group: infra-${{ inputs.environment || github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  terraform:
    runs-on: ubuntu-latest
    environment: ${{ (inputs.environment == 'prod' || github.ref == 'refs/heads/main') && 'production' || '' }}
    defaults:
      run:
        working-directory: infra
    env:
      AZURE_ENV_NAME: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'prod' || 'dev') }}
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
      AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_environment: ${{ inputs.environment || (github.ref == 'refs/heads/main' && 'prod' || 'dev') }}
      TF_VAR_location: ${{ vars.AZURE_LOCATION }}
      TF_VAR_frontend_custom_domain: ${{ (inputs.environment == 'prod' || github.ref == 'refs/heads/main') && vars.FRONTEND_CUSTOM_DOMAIN_PROD || vars.FRONTEND_CUSTOM_DOMAIN_DEV }}
      ARM_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
      ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
      ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.5"
          terraform_wrapper: false

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: |
          # Retry logic for state lock issues (up to 3 attempts with 30s delay)
          for i in 1 2 3; do
            echo "Attempt $i of 3..."
            if terraform plan -out=tfplan -input=false -lock-timeout=120s; then
              echo "Terraform plan succeeded"
              break
            else
              if [ $i -lt 3 ]; then
                echo "Terraform plan failed, waiting 30s before retry..."
                sleep 30
              else
                echo "Terraform plan failed after 3 attempts"
                exit 1
              fi
            fi
          done
        env:
          TF_VAR_subscription_id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_clerk_secret_key: ${{ secrets.CLERK_SECRET_KEY }}
          TF_VAR_clerk_webhook_signing_secret: ${{ secrets.CLERK_WEBHOOK_SIGNING_SECRET }}
          TF_VAR_clerk_publishable_key: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
          TF_VAR_google_api_key: ${{ secrets.GOOGLE_API_KEY }}
          TF_VAR_ctf_master_secret: ${{ secrets.CTF_MASTER_SECRET }}

      - name: Terraform Apply
        if: github.event_name == 'push' || github.event_name == 'workflow_call' || github.event.inputs.apply == 'true'
        run: terraform apply -auto-approve -lock-timeout=120s tfplan
