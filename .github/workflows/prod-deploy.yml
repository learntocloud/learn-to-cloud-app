name: Deploy to Prod

on:
  push:
    branches: [main]
    paths-ignore:
      - 'infra/**'
      - 'docs/**'
  pull_request:
    branches: [main]
  workflow_call:

concurrency:
  group: deploy-prod
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

defaults:
  run:
    shell: bash

jobs:
  # ============================================================
  # STAGE 1: Validation (Lint & Test)
  # ============================================================
  lint-and-test-pr:
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/lint-and-test.yml

  # ============================================================
  # STAGE 2: Build & Promote
  # ============================================================
  lint-and-test:
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    uses: ./.github/workflows/lint-and-test.yml

  # Provision/Update production infrastructure (Terraform)
  create-infra:
    needs: lint-and-test
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    uses: ./.github/workflows/infra-apply.yml
    with:
      environment: prod
    secrets: inherit

  # On push or workflow_call: Promote dev images and deploy to prod
  promote-images:
    needs: [lint-and-test, create-infra]
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    runs-on: ubuntu-latest
    outputs:
      prod_image_tag: ${{ steps.retag.outputs.prod_image_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Log in to Azure Container Registry
        run: |
          az acr login --name ${{ vars.CONTAINER_REGISTRY_NAME }}

      - name: Retag dev image for production
        id: retag
        run: |
          REGISTRY=${{ vars.CONTAINER_REGISTRY_ENDPOINT }}
          SHORT_SHA=${GITHUB_SHA:0:7}
          DEV_TAG="dev-${SHORT_SHA}"
          PROD_TAG="prod-${SHORT_SHA}"

          echo "Pulling dev image: ${REGISTRY}/api:${DEV_TAG}"
          docker pull ${REGISTRY}/api:${DEV_TAG}

          echo "Retagging for production..."
          docker tag ${REGISTRY}/api:${DEV_TAG} ${REGISTRY}/api:${PROD_TAG}
          docker tag ${REGISTRY}/api:${DEV_TAG} ${REGISTRY}/api:prod-latest

          docker push ${REGISTRY}/api:${PROD_TAG}
          docker push ${REGISTRY}/api:prod-latest

          echo "prod_image_tag=${PROD_TAG}" >> "$GITHUB_OUTPUT"
          echo "Successfully promoted dev-${SHORT_SHA} â†’ prod-${SHORT_SHA}"

  deploy:
    needs: promote-images
    if: github.event_name == 'push' || github.event_name == 'workflow_call'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup Azure environment
        uses: ./.github/actions/setup-azure-env
        with:
          environment: prod

      - name: Deploy API
        uses: ./.github/actions/deploy-api
        with:
          environment: prod
          image-tag: ${{ needs.promote-images.outputs.prod_image_tag }}

      - name: Download promoted frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist-${{ github.sha }}
          path: frontend/dist/

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOYMENT_TOKEN_PROD }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "frontend/dist"
          output_location: ""
          skip_app_build: true
          skip_api_build: true
