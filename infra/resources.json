{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "13640595810232244508"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "metadata": {
        "description": "The environment name"
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "The Azure region"
      }
    },
    "tags": {
      "type": "object",
      "metadata": {
        "description": "Resource tags"
      }
    },
    "postgresAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "PostgreSQL administrator password"
      }
    },
    "clerkSecretKey": {
      "type": "securestring",
      "metadata": {
        "description": "Clerk secret key for backend authentication"
      }
    },
    "clerkWebhookSigningSecret": {
      "type": "securestring",
      "metadata": {
        "description": "Clerk webhook signing secret for verifying webhook payloads"
      }
    },
    "clerkPublishableKey": {
      "type": "string",
      "metadata": {
        "description": "Clerk publishable key for frontend authentication"
      }
    },
    "googleApiKey": {
      "type": "securestring",
      "metadata": {
        "description": "Google Gemini API key for LLM features"
      }
    },
    "frontendCustomDomain": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Custom domain for the frontend app (optional)"
      }
    },
    "alertEmailAddress": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Email address for alert notifications (optional)"
      }
    },
    "frontendManagedCertificateName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of the existing managed certificate resource in the Container Apps environment (required when binding a custom domain)"
      }
    }
  },
  "variables": {
    "uniqueSuffix": "[uniqueString(resourceGroup().id)]",
    "appName": "learntocloud",
    "apiAppName": "[format('ca-{0}-api-{1}', variables('appName'), parameters('environment'))]",
    "frontendAppName": "[format('ca-{0}-frontend-{1}', variables('appName'), parameters('environment'))]",
    "keyVaultSecretsUserRoleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
    "apiCorsAllowedOrigins": "[if(not(empty(parameters('frontendCustomDomain'))), createArray('https://*.azurecontainerapps.io', 'http://localhost:3000', format('https://{0}', parameters('frontendCustomDomain'))), createArray('https://*.azurecontainerapps.io', 'http://localhost:3000'))]",
    "acrPullRoleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]"
  },
  "resources": [
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[format('id-{0}-{1}', variables('appName'), parameters('environment'))]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]"
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2023-09-01",
      "name": "[format('log-{0}-{1}', variables('appName'), parameters('environment'))]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "sku": {
          "name": "PerGB2018"
        },
        "retentionInDays": 30
      }
    },
    {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[format('appi-{0}-{1}', variables('appName'), parameters('environment'))]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "kind": "web",
      "properties": {
        "Application_Type": "web",
        "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('log-{0}-{1}', variables('appName'), parameters('environment')))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', format('log-{0}-{1}', variables('appName'), parameters('environment')))]"
      ]
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers",
      "apiVersion": "2023-12-01-preview",
      "name": "[format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix'))]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "sku": {
        "name": "Standard_B1ms",
        "tier": "Burstable"
      },
      "properties": {
        "version": "16",
        "administratorLogin": "ltcadmin",
        "administratorLoginPassword": "[parameters('postgresAdminPassword')]",
        "authConfig": {
          "activeDirectoryAuth": "Enabled",
          "passwordAuth": "Enabled"
        },
        "storage": {
          "storageSizeGB": 32,
          "autoGrow": "Enabled"
        },
        "backup": {
          "backupRetentionDays": 7,
          "geoRedundantBackup": "Disabled"
        },
        "highAvailability": {
          "mode": "Disabled"
        }
      }
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
      "apiVersion": "2023-12-01-preview",
      "name": "[format('{0}/{1}', format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix')), 'learntocloud')]",
      "properties": {
        "charset": "UTF8",
        "collation": "en_US.utf8"
      },
      "dependsOn": [
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers/firewallRules",
      "apiVersion": "2023-12-01-preview",
      "name": "[format('{0}/{1}', format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix')), 'AllowAzureServices')]",
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "0.0.0.0"
      },
      "dependsOn": [
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2023-07-01",
      "name": "[format('crltc{0}', variables('uniqueSuffix'))]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "sku": {
        "name": "Basic"
      },
      "properties": {
        "adminUserEnabled": false
      }
    },
    {
      "type": "Microsoft.App/managedEnvironments",
      "apiVersion": "2024-03-01",
      "name": "[format('cae-{0}-{1}', variables('appName'), parameters('environment'))]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "appLogsConfiguration": {
          "destination": "log-analytics",
          "logAnalyticsConfiguration": {
            "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', format('log-{0}-{1}', variables('appName'), parameters('environment'))), '2023-09-01').customerId]",
            "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', format('log-{0}-{1}', variables('appName'), parameters('environment'))), '2023-09-01').primarySharedKey]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', format('log-{0}-{1}', variables('appName'), parameters('environment')))]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2024-04-01-preview",
      "name": "[format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix'))]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "sku": {
          "family": "A",
          "name": "standard"
        },
        "tenantId": "[subscription().tenantId]",
        "enableRbacAuthorization": true,
        "enableSoftDelete": true,
        "softDeleteRetentionInDays": 90,
        "networkAcls": {
          "bypass": "AzureServices",
          "defaultAction": "Allow"
        }
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2024-04-01-preview",
      "name": "[format('{0}/{1}', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')), 'clerk-secret-key')]",
      "properties": {
        "value": "[parameters('clerkSecretKey')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2024-04-01-preview",
      "name": "[format('{0}/{1}', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')), 'clerk-webhook-signing-secret')]",
      "properties": {
        "value": "[parameters('clerkWebhookSigningSecret')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2024-04-01-preview",
      "name": "[format('{0}/{1}', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')), 'postgres-admin-password')]",
      "properties": {
        "value": "[parameters('postgresAdminPassword')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2024-04-01-preview",
      "name": "[format('{0}/{1}', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')), 'google-api-key')]",
      "properties": {
        "value": "[parameters('googleApiKey')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')))]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix'))), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-{1}', variables('appName'), parameters('environment'))), 'keyVaultSecretsUser')]",
      "properties": {
        "roleDefinitionId": "[variables('keyVaultSecretsUserRoleDefinitionId')]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-{1}', variables('appName'), parameters('environment'))), '2023-01-31').principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[resourceId('Microsoft.KeyVault/vaults', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2024-03-01",
      "name": "[variables('apiAppName')]",
      "location": "[parameters('location')]",
      "tags": "[union(parameters('tags'), createObject('azd-service-name', 'api'))]",
      "identity": {
        "type": "SystemAssigned, UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-{1}', variables('appName'), parameters('environment'))))]": {}
        }
      },
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', format('cae-{0}-{1}', variables('appName'), parameters('environment')))]",
        "configuration": {
          "ingress": {
            "external": true,
            "targetPort": 80,
            "transport": "http",
            "allowInsecure": false,
            "corsPolicy": {
              "allowedOrigins": "[variables('apiCorsAllowedOrigins')]",
              "allowedMethods": [
                "GET",
                "POST",
                "PUT",
                "DELETE",
                "OPTIONS"
              ],
              "allowedHeaders": [
                "*"
              ],
              "allowCredentials": true
            }
          },
          "registries": [
            {
              "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', format('crltc{0}', variables('uniqueSuffix'))), '2023-07-01').loginServer]",
              "identity": "system"
            }
          ],
          "secrets": [
            {
              "name": "clerk-secret-key",
              "keyVaultUrl": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')), 'clerk-secret-key'), '2024-04-01-preview').secretUri]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-{1}', variables('appName'), parameters('environment')))]"
            },
            {
              "name": "clerk-webhook-signing-secret",
              "keyVaultUrl": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')), 'clerk-webhook-signing-secret'), '2024-04-01-preview').secretUri]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-{1}', variables('appName'), parameters('environment')))]"
            },
            {
              "name": "google-api-key",
              "keyVaultUrl": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')), 'google-api-key'), '2024-04-01-preview').secretUri]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-{1}', variables('appName'), parameters('environment')))]"
            }
          ]
        },
        "template": {
          "containers": [
            {
              "name": "api",
              "image": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
              "resources": {
                "cpu": "[json('0.5')]",
                "memory": "1Gi"
              },
              "env": "[concat(createArray(createObject('name', 'POSTGRES_HOST', 'value', reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix'))), '2023-12-01-preview').fullyQualifiedDomainName), createObject('name', 'POSTGRES_DATABASE', 'value', 'learntocloud'), createObject('name', 'POSTGRES_USER', 'value', variables('apiAppName')), createObject('name', 'CLERK_SECRET_KEY', 'secretRef', 'clerk-secret-key'), createObject('name', 'CLERK_WEBHOOK_SIGNING_SECRET', 'secretRef', 'clerk-webhook-signing-secret'), createObject('name', 'CLERK_PUBLISHABLE_KEY', 'value', parameters('clerkPublishableKey')), createObject('name', 'GOOGLE_API_KEY', 'secretRef', 'google-api-key'), createObject('name', 'ENVIRONMENT', 'value', parameters('environment')), createObject('name', 'FRONTEND_URL', 'value', if(not(empty(parameters('frontendCustomDomain'))), format('https://{0}', parameters('frontendCustomDomain')), format('https://{0}.{1}', variables('frontendAppName'), reference(resourceId('Microsoft.App/managedEnvironments', format('cae-{0}-{1}', variables('appName'), parameters('environment'))), '2024-03-01').defaultDomain))), createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', reference(resourceId('Microsoft.Insights/components', format('appi-{0}-{1}', variables('appName'), parameters('environment'))), '2020-02-02').ConnectionString)))]"
            }
          ],
          "scale": {
            "minReplicas": 1,
            "maxReplicas": 10,
            "rules": [
              {
                "name": "http-scaling",
                "http": {
                  "metadata": {
                    "concurrentRequests": "50"
                  }
                }
              }
            ]
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/components', format('appi-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix'))), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix'))), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-{1}', variables('appName'), parameters('environment'))), 'keyVaultSecretsUser'))]",
        "[resourceId('Microsoft.App/managedEnvironments', format('cae-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[resourceId('Microsoft.ContainerRegistry/registries', format('crltc{0}', variables('uniqueSuffix')))]",
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix')))]",
        "[resourceId('Microsoft.KeyVault/vaults/secrets', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')), 'clerk-secret-key')]",
        "[resourceId('Microsoft.KeyVault/vaults/secrets', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')), 'clerk-webhook-signing-secret')]",
        "[resourceId('Microsoft.KeyVault/vaults/secrets', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix')), 'google-api-key')]"
      ]
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2024-03-01",
      "name": "[variables('frontendAppName')]",
      "location": "[parameters('location')]",
      "tags": "[union(parameters('tags'), createObject('azd-service-name', 'frontend'))]",
      "identity": {
        "type": "SystemAssigned, UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-{1}', variables('appName'), parameters('environment'))))]": {}
        }
      },
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', format('cae-{0}-{1}', variables('appName'), parameters('environment')))]",
        "configuration": {
          "ingress": {
            "external": true,
            "targetPort": 80,
            "transport": "http",
            "allowInsecure": false,
            "customDomains": "[if(and(not(empty(parameters('frontendCustomDomain'))), not(empty(parameters('frontendManagedCertificateName')))), createArray(createObject('name', parameters('frontendCustomDomain'), 'bindingType', 'SniEnabled', 'certificateId', resourceId('Microsoft.App/managedEnvironments/managedCertificates', format('cae-{0}-{1}', variables('appName'), parameters('environment')), parameters('frontendManagedCertificateName')))), createArray())]"
          },
          "registries": [
            {
              "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', format('crltc{0}', variables('uniqueSuffix'))), '2023-07-01').loginServer]",
              "identity": "system"
            }
          ]
        },
        "template": {
          "containers": [
            {
              "name": "frontend",
              "image": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
              "resources": {
                "cpu": "[json('0.5')]",
                "memory": "1Gi"
              },
              "env": [
                {
                  "name": "VITE_API_URL",
                  "value": "[format('https://{0}.{1}', variables('apiAppName'), reference(resourceId('Microsoft.App/managedEnvironments', format('cae-{0}-{1}', variables('appName'), parameters('environment'))), '2024-03-01').defaultDomain)]"
                },
                {
                  "name": "VITE_CLERK_PUBLISHABLE_KEY",
                  "value": "[parameters('clerkPublishableKey')]"
                },
                {
                  "name": "PORT",
                  "value": "80"
                }
              ]
            }
          ],
          "scale": {
            "minReplicas": 1,
            "maxReplicas": 10,
            "rules": [
              {
                "name": "http-scaling",
                "http": {
                  "metadata": {
                    "concurrentRequests": "50"
                  }
                }
              }
            ]
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps', variables('apiAppName'))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix'))), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix'))), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('id-{0}-{1}', variables('appName'), parameters('environment'))), 'keyVaultSecretsUser'))]",
        "[resourceId('Microsoft.App/managedEnvironments', format('cae-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[resourceId('Microsoft.ContainerRegistry/registries', format('crltc{0}', variables('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', format('crltc{0}', variables('uniqueSuffix')))]",
      "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', format('crltc{0}', variables('uniqueSuffix'))), resourceId('Microsoft.App/containerApps', variables('apiAppName')), 'acrPull')]",
      "properties": {
        "roleDefinitionId": "[variables('acrPullRoleDefinitionId')]",
        "principalId": "[reference(resourceId('Microsoft.App/containerApps', variables('apiAppName')), '2024-03-01', 'full').identity.principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps', variables('apiAppName'))]",
        "[resourceId('Microsoft.ContainerRegistry/registries', format('crltc{0}', variables('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', format('crltc{0}', variables('uniqueSuffix')))]",
      "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', format('crltc{0}', variables('uniqueSuffix'))), resourceId('Microsoft.App/containerApps', variables('frontendAppName')), 'acrPull')]",
      "properties": {
        "roleDefinitionId": "[variables('acrPullRoleDefinitionId')]",
        "principalId": "[reference(resourceId('Microsoft.App/containerApps', variables('frontendAppName')), '2024-03-01', 'full').identity.principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', format('crltc{0}', variables('uniqueSuffix')))]",
        "[resourceId('Microsoft.App/containerApps', variables('frontendAppName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/actionGroups",
      "apiVersion": "2023-01-01",
      "name": "[format('ag-{0}-{1}', variables('appName'), parameters('environment'))]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "groupShortName": "ltc-alerts",
        "enabled": true,
        "emailReceivers": "[if(not(equals(parameters('alertEmailAddress'), '')), createArray(createObject('name', 'EmailAlert', 'emailAddress', parameters('alertEmailAddress'), 'useCommonAlertSchema', true())), createArray())]",
        "armRoleReceivers": [
          {
            "name": "SubscriptionOwners",
            "roleId": "8e3af657-a8ff-443c-a75c-2fe8c4bcb635",
            "useCommonAlertSchema": true
          }
        ]
      }
    },
    {
      "type": "Microsoft.Insights/metricAlerts",
      "apiVersion": "2018-03-01",
      "name": "[format('alert-{0}-error-rate', variables('apiAppName'))]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "description": "Alert when API error rate exceeds 5%",
        "severity": 2,
        "enabled": true,
        "scopes": [
          "[resourceId('Microsoft.App/containerApps', variables('apiAppName'))]"
        ],
        "evaluationFrequency": "PT5M",
        "windowSize": "PT15M",
        "criteria": {
          "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
          "allOf": [
            {
              "name": "HighErrorRate",
              "metricName": "Requests",
              "metricNamespace": "Microsoft.App/containerApps",
              "operator": "GreaterThan",
              "threshold": 10,
              "timeAggregation": "Total",
              "dimensions": [
                {
                  "name": "statusCodeCategory",
                  "operator": "Include",
                  "values": [
                    "5xx"
                  ]
                }
              ],
              "criterionType": "StaticThresholdCriterion"
            }
          ]
        },
        "actions": [
          {
            "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]"
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[resourceId('Microsoft.App/containerApps', variables('apiAppName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/metricAlerts",
      "apiVersion": "2018-03-01",
      "name": "[format('alert-{0}-requests', variables('apiAppName'))]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "description": "Alert when API receives unusually high request volume",
        "severity": 3,
        "enabled": true,
        "scopes": [
          "[resourceId('Microsoft.App/containerApps', variables('apiAppName'))]"
        ],
        "evaluationFrequency": "PT5M",
        "windowSize": "PT15M",
        "criteria": {
          "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
          "allOf": [
            {
              "name": "HighRequests",
              "metricName": "Requests",
              "metricNamespace": "Microsoft.App/containerApps",
              "operator": "GreaterThan",
              "threshold": 10000,
              "timeAggregation": "Total",
              "criterionType": "StaticThresholdCriterion"
            }
          ]
        },
        "actions": [
          {
            "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]"
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[resourceId('Microsoft.App/containerApps', variables('apiAppName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/metricAlerts",
      "apiVersion": "2018-03-01",
      "name": "[format('alert-{0}-restarts', variables('apiAppName'))]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "description": "Alert when API container restarts frequently",
        "severity": 2,
        "enabled": true,
        "scopes": [
          "[resourceId('Microsoft.App/containerApps', variables('apiAppName'))]"
        ],
        "evaluationFrequency": "PT5M",
        "windowSize": "PT15M",
        "criteria": {
          "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
          "allOf": [
            {
              "name": "FrequentRestarts",
              "metricName": "RestartCount",
              "metricNamespace": "Microsoft.App/containerApps",
              "operator": "GreaterThan",
              "threshold": 3,
              "timeAggregation": "Total",
              "criterionType": "StaticThresholdCriterion"
            }
          ]
        },
        "actions": [
          {
            "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]"
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[resourceId('Microsoft.App/containerApps', variables('apiAppName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/metricAlerts",
      "apiVersion": "2018-03-01",
      "name": "[format('alert-{0}-error-rate', variables('frontendAppName'))]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "description": "Alert when Frontend error rate is high",
        "severity": 2,
        "enabled": true,
        "scopes": [
          "[resourceId('Microsoft.App/containerApps', variables('frontendAppName'))]"
        ],
        "evaluationFrequency": "PT5M",
        "windowSize": "PT15M",
        "criteria": {
          "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
          "allOf": [
            {
              "name": "HighErrorRate",
              "metricName": "Requests",
              "metricNamespace": "Microsoft.App/containerApps",
              "operator": "GreaterThan",
              "threshold": 10,
              "timeAggregation": "Total",
              "dimensions": [
                {
                  "name": "statusCodeCategory",
                  "operator": "Include",
                  "values": [
                    "5xx"
                  ]
                }
              ],
              "criterionType": "StaticThresholdCriterion"
            }
          ]
        },
        "actions": [
          {
            "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]"
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[resourceId('Microsoft.App/containerApps', variables('frontendAppName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/metricAlerts",
      "apiVersion": "2018-03-01",
      "name": "[format('alert-postgres-{0}-cpu', parameters('environment'))]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "description": "Alert when PostgreSQL CPU exceeds 80%",
        "severity": 2,
        "enabled": true,
        "scopes": [
          "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix')))]"
        ],
        "evaluationFrequency": "PT5M",
        "windowSize": "PT15M",
        "criteria": {
          "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
          "allOf": [
            {
              "name": "HighCPU",
              "metricName": "cpu_percent",
              "metricNamespace": "Microsoft.DBforPostgreSQL/flexibleServers",
              "operator": "GreaterThan",
              "threshold": 80,
              "timeAggregation": "Average",
              "criterionType": "StaticThresholdCriterion"
            }
          ]
        },
        "actions": [
          {
            "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]"
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Insights/metricAlerts",
      "apiVersion": "2018-03-01",
      "name": "[format('alert-postgres-{0}-storage', parameters('environment'))]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "description": "Alert when PostgreSQL storage exceeds 80%",
        "severity": 2,
        "enabled": true,
        "scopes": [
          "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix')))]"
        ],
        "evaluationFrequency": "PT1H",
        "windowSize": "PT1H",
        "criteria": {
          "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
          "allOf": [
            {
              "name": "HighStorage",
              "metricName": "storage_percent",
              "metricNamespace": "Microsoft.DBforPostgreSQL/flexibleServers",
              "operator": "GreaterThan",
              "threshold": 80,
              "timeAggregation": "Average",
              "criterionType": "StaticThresholdCriterion"
            }
          ]
        },
        "actions": [
          {
            "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]"
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Insights/metricAlerts",
      "apiVersion": "2018-03-01",
      "name": "[format('alert-postgres-{0}-connections', parameters('environment'))]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "description": "Alert when PostgreSQL has connection failures",
        "severity": 2,
        "enabled": true,
        "scopes": [
          "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix')))]"
        ],
        "evaluationFrequency": "PT5M",
        "windowSize": "PT15M",
        "criteria": {
          "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
          "allOf": [
            {
              "name": "ConnectionFailures",
              "metricName": "connections_failed",
              "metricNamespace": "Microsoft.DBforPostgreSQL/flexibleServers",
              "operator": "GreaterThan",
              "threshold": 5,
              "timeAggregation": "Total",
              "criterionType": "StaticThresholdCriterion"
            }
          ]
        },
        "actions": [
          {
            "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]"
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Insights/metricAlerts",
      "apiVersion": "2018-03-01",
      "name": "[format('alert-appinsights-{0}-failed-requests', parameters('environment'))]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "description": "Alert when Application Insights detects failed requests",
        "severity": 2,
        "enabled": true,
        "scopes": [
          "[resourceId('Microsoft.Insights/components', format('appi-{0}-{1}', variables('appName'), parameters('environment')))]"
        ],
        "evaluationFrequency": "PT5M",
        "windowSize": "PT15M",
        "criteria": {
          "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
          "allOf": [
            {
              "name": "FailedRequests",
              "metricName": "requests/failed",
              "metricNamespace": "microsoft.insights/components",
              "operator": "GreaterThan",
              "threshold": 10,
              "timeAggregation": "Count",
              "criterionType": "StaticThresholdCriterion"
            }
          ]
        },
        "actions": [
          {
            "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]"
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[resourceId('Microsoft.Insights/components', format('appi-{0}-{1}', variables('appName'), parameters('environment')))]"
      ]
    },
    {
      "type": "Microsoft.Insights/metricAlerts",
      "apiVersion": "2018-03-01",
      "name": "[format('alert-appinsights-{0}-exceptions', parameters('environment'))]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "description": "Alert when Application Insights detects high exception rate",
        "severity": 2,
        "enabled": true,
        "scopes": [
          "[resourceId('Microsoft.Insights/components', format('appi-{0}-{1}', variables('appName'), parameters('environment')))]"
        ],
        "evaluationFrequency": "PT5M",
        "windowSize": "PT15M",
        "criteria": {
          "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
          "allOf": [
            {
              "name": "HighExceptions",
              "metricName": "exceptions/count",
              "metricNamespace": "microsoft.insights/components",
              "operator": "GreaterThan",
              "threshold": 20,
              "timeAggregation": "Count",
              "criterionType": "StaticThresholdCriterion"
            }
          ]
        },
        "actions": [
          {
            "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]"
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/actionGroups', format('ag-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[resourceId('Microsoft.Insights/components', format('appi-{0}-{1}', variables('appName'), parameters('environment')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "monitoring-dashboard",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "apiAppId": {
            "value": "[resourceId('Microsoft.App/containerApps', variables('apiAppName'))]"
          },
          "frontendAppId": {
            "value": "[resourceId('Microsoft.App/containerApps', variables('frontendAppName'))]"
          },
          "postgresServerId": {
            "value": "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix')))]"
          },
          "appInsightsId": {
            "value": "[resourceId('Microsoft.Insights/components', format('appi-{0}-{1}', variables('appName'), parameters('environment')))]"
          },
          "logAnalyticsId": {
            "value": "[resourceId('Microsoft.OperationalInsights/workspaces', format('log-{0}-{1}', variables('appName'), parameters('environment')))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14599671857825121183"
            }
          },
          "parameters": {
            "environment": {
              "type": "string",
              "metadata": {
                "description": "The environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "apiAppId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the API Container App"
              }
            },
            "frontendAppId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Frontend Container App"
              }
            },
            "postgresServerId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the PostgreSQL Flexible Server"
              }
            },
            "appInsightsId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of Application Insights"
              }
            },
            "logAnalyticsId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of Log Analytics Workspace"
              }
            }
          },
          "variables": {
            "dashboardName": "[format('dashboard-learntocloud-{0}', parameters('environment'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Portal/dashboards",
              "apiVersion": "2020-09-01-preview",
              "name": "[variables('dashboardName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('hidden-title', format('Learn to Cloud - {0}', parameters('environment'))))]",
              "properties": {
                "lenses": [
                  {
                    "order": 0,
                    "parts": [
                      {
                        "position": {
                          "x": 0,
                          "y": 0,
                          "colSpan": 4,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('apiAppId')]"
                                      },
                                      "name": "UsageNanoCores",
                                      "aggregationType": 4,
                                      "namespace": "Microsoft.App/containerApps",
                                      "metricVisualization": {
                                        "displayName": "CPU Usage",
                                        "resourceDisplayName": "API"
                                      }
                                    }
                                  ],
                                  "title": "API - CPU Usage",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 4,
                          "y": 0,
                          "colSpan": 4,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('apiAppId')]"
                                      },
                                      "name": "WorkingSetBytes",
                                      "aggregationType": 4,
                                      "namespace": "Microsoft.App/containerApps",
                                      "metricVisualization": {
                                        "displayName": "Memory Working Set",
                                        "resourceDisplayName": "API"
                                      }
                                    }
                                  ],
                                  "title": "API - Memory Usage",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 8,
                          "y": 0,
                          "colSpan": 4,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('apiAppId')]"
                                      },
                                      "name": "Replicas",
                                      "aggregationType": 4,
                                      "namespace": "Microsoft.App/containerApps",
                                      "metricVisualization": {
                                        "displayName": "Replica Count",
                                        "resourceDisplayName": "API"
                                      }
                                    }
                                  ],
                                  "title": "API - Replica Count",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 12,
                          "y": 0,
                          "colSpan": 4,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('apiAppId')]"
                                      },
                                      "name": "Requests",
                                      "aggregationType": 1,
                                      "namespace": "Microsoft.App/containerApps",
                                      "metricVisualization": {
                                        "displayName": "Total Requests",
                                        "resourceDisplayName": "API"
                                      }
                                    }
                                  ],
                                  "title": "API - Request Count",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 0,
                          "y": 3,
                          "colSpan": 6,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('apiAppId')]"
                                      },
                                      "name": "Requests",
                                      "aggregationType": 1,
                                      "namespace": "Microsoft.App/containerApps",
                                      "metricVisualization": {
                                        "displayName": "Requests by Status",
                                        "resourceDisplayName": "API"
                                      }
                                    }
                                  ],
                                  "title": "API - Requests by Status Code",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "grouping": {
                                    "dimension": "statusCodeCategory",
                                    "sort": 2,
                                    "top": 10
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 6,
                          "y": 3,
                          "colSpan": 6,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('appInsightsId')]"
                                      },
                                      "name": "requests/duration",
                                      "aggregationType": 4,
                                      "namespace": "microsoft.insights/components",
                                      "metricVisualization": {
                                        "displayName": "Avg Response Time",
                                        "resourceDisplayName": "App Insights"
                                      }
                                    }
                                  ],
                                  "title": "API - Response Time (App Insights)",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 12,
                          "y": 3,
                          "colSpan": 4,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('appInsightsId')]"
                                      },
                                      "name": "requests/failed",
                                      "aggregationType": 1,
                                      "namespace": "microsoft.insights/components",
                                      "metricVisualization": {
                                        "displayName": "Failed Requests",
                                        "resourceDisplayName": "App Insights"
                                      }
                                    }
                                  ],
                                  "title": "API - Failed Requests",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 0,
                          "y": 6,
                          "colSpan": 4,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('postgresServerId')]"
                                      },
                                      "name": "cpu_percent",
                                      "aggregationType": 4,
                                      "namespace": "Microsoft.DBforPostgreSQL/flexibleServers",
                                      "metricVisualization": {
                                        "displayName": "CPU Percent",
                                        "resourceDisplayName": "PostgreSQL"
                                      }
                                    }
                                  ],
                                  "title": "PostgreSQL - CPU %",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 4,
                          "y": 6,
                          "colSpan": 4,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('postgresServerId')]"
                                      },
                                      "name": "memory_percent",
                                      "aggregationType": 4,
                                      "namespace": "Microsoft.DBforPostgreSQL/flexibleServers",
                                      "metricVisualization": {
                                        "displayName": "Memory Percent",
                                        "resourceDisplayName": "PostgreSQL"
                                      }
                                    }
                                  ],
                                  "title": "PostgreSQL - Memory %",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 8,
                          "y": 6,
                          "colSpan": 4,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('postgresServerId')]"
                                      },
                                      "name": "active_connections",
                                      "aggregationType": 4,
                                      "namespace": "Microsoft.DBforPostgreSQL/flexibleServers",
                                      "metricVisualization": {
                                        "displayName": "Active Connections",
                                        "resourceDisplayName": "PostgreSQL"
                                      }
                                    }
                                  ],
                                  "title": "PostgreSQL - Active Connections",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 12,
                          "y": 6,
                          "colSpan": 4,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('postgresServerId')]"
                                      },
                                      "name": "storage_used",
                                      "aggregationType": 4,
                                      "namespace": "Microsoft.DBforPostgreSQL/flexibleServers",
                                      "metricVisualization": {
                                        "displayName": "Storage Used",
                                        "resourceDisplayName": "PostgreSQL"
                                      }
                                    }
                                  ],
                                  "title": "PostgreSQL - Storage Used",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 0,
                          "y": 9,
                          "colSpan": 4,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('frontendAppId')]"
                                      },
                                      "name": "UsageNanoCores",
                                      "aggregationType": 4,
                                      "namespace": "Microsoft.App/containerApps",
                                      "metricVisualization": {
                                        "displayName": "CPU Usage",
                                        "resourceDisplayName": "Frontend"
                                      }
                                    }
                                  ],
                                  "title": "Frontend - CPU Usage",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 4,
                          "y": 9,
                          "colSpan": 4,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('frontendAppId')]"
                                      },
                                      "name": "WorkingSetBytes",
                                      "aggregationType": 4,
                                      "namespace": "Microsoft.App/containerApps",
                                      "metricVisualization": {
                                        "displayName": "Memory Working Set",
                                        "resourceDisplayName": "Frontend"
                                      }
                                    }
                                  ],
                                  "title": "Frontend - Memory Usage",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 8,
                          "y": 9,
                          "colSpan": 4,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('frontendAppId')]"
                                      },
                                      "name": "Requests",
                                      "aggregationType": 1,
                                      "namespace": "Microsoft.App/containerApps",
                                      "metricVisualization": {
                                        "displayName": "Total Requests",
                                        "resourceDisplayName": "Frontend"
                                      }
                                    }
                                  ],
                                  "title": "Frontend - Request Count",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 12,
                          "y": 9,
                          "colSpan": 4,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('frontendAppId')]"
                                      },
                                      "name": "Requests",
                                      "aggregationType": 1,
                                      "namespace": "Microsoft.App/containerApps",
                                      "metricVisualization": {
                                        "displayName": "Requests by Status",
                                        "resourceDisplayName": "Frontend"
                                      }
                                    }
                                  ],
                                  "title": "Frontend - Requests by Status",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "grouping": {
                                    "dimension": "statusCodeCategory",
                                    "sort": 2,
                                    "top": 10
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 0,
                          "y": 12,
                          "colSpan": 6,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('appInsightsId')]"
                                      },
                                      "name": "dependencies/duration",
                                      "aggregationType": 4,
                                      "namespace": "microsoft.insights/components",
                                      "metricVisualization": {
                                        "displayName": "Dependency Duration",
                                        "resourceDisplayName": "App Insights"
                                      }
                                    }
                                  ],
                                  "title": "Dependency Call Duration (DB, External APIs)",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 6,
                          "y": 12,
                          "colSpan": 6,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                          "inputs": [
                            {
                              "name": "options",
                              "value": {
                                "chart": {
                                  "metrics": [
                                    {
                                      "resourceMetadata": {
                                        "id": "[parameters('appInsightsId')]"
                                      },
                                      "name": "dependencies/failed",
                                      "aggregationType": 1,
                                      "namespace": "microsoft.insights/components",
                                      "metricVisualization": {
                                        "displayName": "Failed Dependencies",
                                        "resourceDisplayName": "App Insights"
                                      }
                                    }
                                  ],
                                  "title": "Failed Dependency Calls",
                                  "titleKind": 1,
                                  "visualization": {
                                    "chartType": 2,
                                    "legendVisualization": {
                                      "isVisible": true,
                                      "position": 2,
                                      "hideSubtitle": false
                                    },
                                    "axisVisualization": {
                                      "x": {
                                        "isVisible": true,
                                        "axisType": 2
                                      },
                                      "y": {
                                        "isVisible": true,
                                        "axisType": 1
                                      }
                                    }
                                  },
                                  "timespan": {
                                    "relative": {
                                      "duration": 86400000
                                    },
                                    "showUTCTime": false,
                                    "grain": 1
                                  }
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "position": {
                          "x": 12,
                          "y": 12,
                          "colSpan": 4,
                          "rowSpan": 3
                        },
                        "metadata": {
                          "type": "Extension/HubsExtension/PartType/MarkdownPart",
                          "inputs": [],
                          "settings": {
                            "content": {
                              "content": "[format('## Learn to Cloud\n### {0} Environment\n\n**Quick Links:**\n- [Application Insights](https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/microsoft.insights%2Fcomponents)\n- [Log Analytics](https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.OperationalInsights%2Fworkspaces)\n- [Alerts](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/alertsV2)\n\n**Timespan:** Last 24 hours', parameters('environment'))]",
                              "title": "Dashboard Info",
                              "subtitle": "",
                              "markdownSource": 1,
                              "markdownUri": ""
                            }
                          }
                        }
                      }
                    ]
                  }
                ],
                "metadata": {
                  "model": {
                    "timeRange": {
                      "value": {
                        "relative": {
                          "duration": 24,
                          "timeUnit": 1
                        }
                      },
                      "type": "MsPortalFx.Composition.Configuration.ValueTypes.TimeRange"
                    },
                    "filterLocale": {
                      "value": "en-us"
                    },
                    "filters": {
                      "value": {
                        "MsPortalFx_TimeRange": {
                          "model": {
                            "format": "utc",
                            "granularity": "auto",
                            "relative": "24h"
                          },
                          "displayCache": {
                            "name": "UTC Time",
                            "value": "Past 24 hours"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "dashboardId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Portal/dashboards', variables('dashboardName'))]"
            },
            "dashboardName": {
              "type": "string",
              "value": "[variables('dashboardName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps', variables('apiAppName'))]",
        "[resourceId('Microsoft.Insights/components', format('appi-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[resourceId('Microsoft.App/containerApps', variables('frontendAppName'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces', format('log-{0}-{1}', variables('appName'), parameters('environment')))]",
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix')))]"
      ]
    }
  ],
  "outputs": {
    "apiUrl": {
      "type": "string",
      "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', variables('apiAppName')), '2024-03-01').configuration.ingress.fqdn)]"
    },
    "frontendUrl": {
      "type": "string",
      "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', variables('frontendAppName')), '2024-03-01').configuration.ingress.fqdn)]"
    },
    "postgresHost": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', format('psql-{0}-{1}-{2}', variables('appName'), parameters('environment'), variables('uniqueSuffix'))), '2023-12-01-preview').fullyQualifiedDomainName]"
    },
    "apiAppName": {
      "type": "string",
      "value": "[variables('apiAppName')]"
    },
    "frontendAppName": {
      "type": "string",
      "value": "[variables('frontendAppName')]"
    },
    "containerRegistryName": {
      "type": "string",
      "value": "[format('crltc{0}', variables('uniqueSuffix'))]"
    },
    "containerRegistryLoginServer": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', format('crltc{0}', variables('uniqueSuffix'))), '2023-07-01').loginServer]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix'))]"
    },
    "keyVaultUri": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.KeyVault/vaults', format('kv-ltc-{0}-{1}', parameters('environment'), variables('uniqueSuffix'))), '2024-04-01-preview').vaultUri]"
    },
    "dashboardId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'monitoring-dashboard'), '2025-04-01').outputs.dashboardId.value]"
    }
  }
}
