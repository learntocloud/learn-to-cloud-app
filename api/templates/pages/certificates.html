{% extends "layouts/content_page.html" %}
{% block title %}Certificates - Learn to Cloud{% endblock %}

{% block page_header %}
<h1 class="text-3xl font-bold text-gray-900 dark:text-white">Certificates</h1>
{% endblock %}

{% block page_body %}
<div id="certificates-content">

{% if certificate %}
{# ‚îÄ‚îÄ Celebration banner ‚îÄ‚îÄ #}
<div class="relative overflow-hidden p-6 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 dark:from-emerald-600 dark:to-teal-800 mb-8 shadow">
    <div class="flex items-center gap-4">
        <span class="text-4xl">üéì</span>
        <div>
            <h2 class="text-lg font-bold text-white">Congratulations, {{ certificate.recipient_name }}!</h2>
            <p class="text-sm text-emerald-100">You completed all {{ progress.total_phases }} phases of Learn to Cloud.</p>
        </div>
    </div>
</div>

{# ‚îÄ‚îÄ Certificate card ‚îÄ‚îÄ #}
<div class="rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
    {# Preview thumbnail #}
    <div class="bg-gray-50 dark:bg-gray-800/50 p-6 flex justify-center">
        <a href="/api/certificates/mine/png" download hx-boost="false" class="block group">
            <img
                src="/api/certificates/mine/png"
                alt="Certificate of Completion"
                class="max-w-md w-full rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 group-hover:shadow-md transition-shadow"
                loading="lazy"
            >
        </a>
    </div>

    {# Certificate details #}
    <div class="p-6">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Full Completion Certificate</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">Issued {{ certificate.issued_at.strftime('%B %d, %Y') }}</p>
            </div>
        </div>

        {# Metadata #}
        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 text-sm">
            <div>
                <dt class="font-medium text-gray-500 dark:text-gray-400">Recipient</dt>
                <dd class="text-gray-900 dark:text-white mt-0.5">{{ certificate.recipient_name }}</dd>
            </div>
            <div>
                <dt class="font-medium text-gray-500 dark:text-gray-400">Verification Code</dt>
                <dd class="mt-0.5 flex items-center gap-2">
                    <code class="text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded-sm text-xs font-mono">{{ certificate.verification_code }}</code>
                    <button
                        x-data="{ copied: false }"
                        @click="
                            const text = '{{ certificate.verification_code }}';
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                navigator.clipboard.writeText(text).then(() => { copied = true; setTimeout(() => copied = false, 2000); });
                            } else {
                                const ta = document.createElement('textarea');
                                ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
                                document.body.appendChild(ta); ta.select(); document.execCommand('copy');
                                document.body.removeChild(ta); copied = true; setTimeout(() => copied = false, 2000);
                            }
                        "
                        class="text-blue-600 dark:text-blue-400 text-xs hover:underline"
                        x-text="copied ? 'Copied!' : 'Copy'"
                        aria-label="Copy verification code"
                    ></button>
                </dd>
            </div>
        </dl>

        {# Action buttons #}
        <div class="flex flex-wrap gap-3">
            <a href="/api/certificates/mine/pdf" download hx-boost="false"
               class="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white shadow-xs hover:bg-blue-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Download PDF
            </a>
            <a href="/api/certificates/mine/png" download hx-boost="false"
               class="inline-flex items-center gap-2 rounded-lg bg-gray-100 dark:bg-gray-800 px-4 py-2.5 text-sm font-semibold text-gray-700 dark:text-gray-200 shadow-xs hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Download PNG
            </a>
        </div>

        {# Share & verify links #}
        <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-800 flex flex-wrap gap-4">
            <a href="/verify/{{ certificate.verification_code }}"
               class="inline-flex items-center gap-1.5 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                Verification page
            </a>
            <a href="https://www.linkedin.com/profile/add?startTask=CERTIFICATION_NAME&name=Learn%20to%20Cloud%20-%20Full%20Completion&organizationName=Learn%20to%20Cloud&issueYear={{ certificate.issued_at.strftime('%Y') }}&issueMonth={{ certificate.issued_at.strftime('%-m') }}&certUrl={{ request.url_for('verify_page', code=certificate.verification_code) }}&certId={{ certificate.verification_code }}"
               target="_blank" rel="noopener noreferrer"
               class="inline-flex items-center gap-1.5 text-sm text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                Add to LinkedIn
            </a>
            <button
                x-data="{ copied: false }"
                @click="
                    const url = window.location.origin + '/verify/{{ certificate.verification_code }}';
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(url).then(() => { copied = true; setTimeout(() => copied = false, 2000); });
                    } else {
                        const ta = document.createElement('textarea');
                        ta.value = url; ta.style.position = 'fixed'; ta.style.opacity = '0';
                        document.body.appendChild(ta); ta.select(); document.execCommand('copy');
                        document.body.removeChild(ta); copied = true; setTimeout(() => copied = false, 2000);
                    }
                "
                class="inline-flex items-center gap-1.5 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors"
                aria-label="Copy shareable link"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>
                <span x-text="copied ? 'Link copied!' : 'Copy share link'"></span>
            </button>
        </div>
    </div>
</div>

{% elif eligible %}
{# ‚îÄ‚îÄ Eligible: generate certificate ‚îÄ‚îÄ #}
<div class="relative overflow-hidden p-6 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 dark:from-green-600 dark:to-emerald-800 mb-8 shadow">
    <div class="flex items-center gap-4">
        <span class="text-4xl">üéâ</span>
        <div class="flex-1">
            <h2 class="text-lg font-bold text-white">You're eligible for a certificate!</h2>
            <p class="text-sm text-green-100 mb-4">You've completed all {{ progress.total_phases }} phases. Generate your certificate now.</p>
            <form hx-post="/htmx/certificates" hx-target="#certificates-content" hx-swap="innerHTML" hx-indicator="#gen-spinner">
                <input type="hidden" name="recipient_name" value="{{ user.first_name }} {{ user.last_name }}">
                <button type="submit"
                    class="inline-flex items-center gap-2 rounded-lg bg-white px-5 py-2.5 text-sm font-semibold text-green-700 shadow-xs hover:bg-green-50 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    Generate Certificate
                    <span id="gen-spinner" class="htmx-indicator">
                        <svg class="animate-spin h-4 w-4 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                </button>
            </form>
        </div>
    </div>
</div>

{% else %}
{# ‚îÄ‚îÄ Not eligible: show progress toward certificate ‚îÄ‚îÄ #}
<div class="rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
    <div class="p-6 border-b border-gray-100 dark:border-gray-800">
        <div class="flex items-center gap-3 mb-1">
            <span class="text-2xl">üèÜ</span>
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Earn Your Certificate</h2>
        </div>
        <p class="text-sm text-gray-600 dark:text-gray-400 ml-9">
            Complete all {{ progress.total_phases }} phases to earn your Learn to Cloud certificate.
        </p>
    </div>

    {# Overall progress bar #}
    <div class="px-6 pt-5 pb-2">
        <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Overall Progress</span>
            <span class="text-sm font-semibold text-gray-900 dark:text-white">{{ "%.0f"|format(progress.overall_percentage) }}%</span>
        </div>
        <div class="h-2.5 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
            <div class="h-full rounded-full bg-blue-500 transition-all" style="width: {{ progress.overall_percentage }}%"></div>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1.5">{{ progress.phases_completed }} of {{ progress.total_phases }} phases completed</p>
    </div>

    {# Per-phase progress #}
    <div class="p-6 space-y-3">
        {% for phase_id in progress.phases | sort %}
        {% set phase = progress.phases[phase_id] %}
        <a href="/phase/{{ phase_id }}" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
            <span class="flex items-center justify-center h-7 w-7 rounded-full text-xs font-semibold shrink-0
                {% if phase.is_complete %}bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-400
                {% elif phase.steps_completed > 0 %}bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-400
                {% else %}bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-500{% endif %}">
                {% if phase.is_complete %}
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
                {% else %}
                {{ phase_id }}
                {% endif %}
            </span>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-900 dark:text-white truncate">Phase {{ phase_id }}</p>
                <div class="flex items-center gap-2 mt-1">
                    <div class="flex-1 h-1.5 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
                        <div class="h-full rounded-full transition-all {% if phase.is_complete %}bg-green-500{% else %}bg-blue-500{% endif %}" style="width: {{ phase.overall_percentage }}%"></div>
                    </div>
                    <span class="text-xs text-gray-500 dark:text-gray-400 shrink-0">{{ phase.steps_completed }}/{{ phase.steps_required }}</span>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>

    <div class="px-6 pb-6">
        <a href="/dashboard" class="inline-flex items-center gap-1.5 text-sm font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 transition-colors">
            Go to Dashboard
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
        </a>
    </div>
</div>
{% endif %}

</div>
{% endblock %}
