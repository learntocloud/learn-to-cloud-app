{% extends "base.html" %}
{% block title %}{{ phase.name }} - Learn to Cloud{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex items-center gap-3 mb-2">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{{ phase.name }}</h1>
    </div>
    <p class="text-gray-600 dark:text-gray-400 mt-2">{{ phase.description }}</p>

    {% if progress %}
    {% with progress=progress, progress_label=progress.percentage ~ '% complete' %}
    {% include "partials/progress_bar.html" %}
    {% endwith %}
    {% endif %}
</div>

<div class="mb-12">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Topics</h2>
    <div class="space-y-3">
        {% for topic in topics %}
        <a href="/phase/{{ phase.order }}/{{ topic.slug }}" class="flex items-center justify-between p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-400 transition-colors">
            <div class="flex items-center gap-3">
                <span class="font-medium text-gray-900 dark:text-gray-100">{{ topic.name }}</span>
            </div>
            {% if topic.progress %}
            <span class="text-sm flex items-center gap-1.5 {% if topic.progress.completed == topic.progress.total and topic.progress.total > 0 %}text-green-600 dark:text-green-400 font-medium{% else %}text-gray-500 dark:text-gray-400{% endif %}">
                {% if topic.progress.completed == topic.progress.total and topic.progress.total > 0 %}
                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Complete
                {% else %}
                {{ topic.progress.completed }}/{{ topic.progress.total }} steps
                {% endif %}
            </span>
            {% endif %}
        </a>
        {% endfor %}
    </div>
</div>

{% if requirements %}
<div id="verification-section">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Hands-on Verification</h2>

    {% if verification_locked %}
    {# Phase verification is gated â€” prerequisite phase not yet complete #}
    <div class="rounded-lg border border-amber-200 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/20 p-4 mb-4">
        <div class="flex items-start gap-3">
            <span class="text-amber-500 dark:text-amber-400 text-lg mt-0.5">ðŸ”’</span>
            <div>
                <p class="text-sm font-medium text-amber-800 dark:text-amber-200">
                    Phase {{ prerequisite_phase_id }} verification required
                </p>
                <p class="text-sm text-amber-700 dark:text-amber-300 mt-1">
                    Complete all hands-on verifications in
                    <a href="/phase/{{ prerequisite_phase_id }}" class="underline hover:no-underline font-medium">Phase {{ prerequisite_phase_id }}</a>
                    before submitting here.
                </p>
            </div>
        </div>
    </div>
    <div class="space-y-2">
        {% for req in requirements %}
        <div class="flex items-center gap-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 px-4 py-2.5 opacity-50">
            <span class="text-gray-400 dark:text-gray-500">ðŸ”’</span>
            <span class="text-sm text-gray-500 dark:text-gray-400">{{ req.name }}</span>
        </div>
        {% endfor %}
    </div>
    {% else %}
    {% set ns = namespace(found_active=false) %}
    <div class="space-y-2">
        {% for req in requirements %}
        {% set submission = submissions_by_req.get(req.id) %}
        {% set is_verified = submission and submission.is_validated %}
        {% set fb = feedback_by_req.get(req.id, {}) if feedback_by_req is defined else {} %}
        {% set feedback_tasks = fb.get('tasks', []) if fb else [] %}
        {% set feedback_passed = fb.get('passed', 0) if fb else 0 %}
        {% set cooldown_secs = fb.get('cooldown_seconds', None) if fb else None %}
        {% set persisted_error = submission.validation_message if submission and not submission.is_validated and submission.validation_message else None %}

        {% if is_verified %}
        {# Compact verified row #}
        <div id="requirement-{{ req.id }}" class="flex items-center gap-3 rounded-lg border border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20 px-4 py-2.5">
            <span class="text-green-600 dark:text-green-400">âœ“</span>
            <span class="text-sm font-medium text-green-800 dark:text-green-200">{{ req.name }}</span>
        </div>
        {% elif not ns.found_active %}
        {# First incomplete â€” show full card #}
        {% set ns.found_active = true %}
        {% with requirement=req, submission=submission, feedback_tasks=feedback_tasks, feedback_passed=feedback_passed, phase_id=phase.order, cooldown_seconds=cooldown_secs, cooldown_message=None, error_banner=persisted_error, server_error=False, server_error_message=None %}
        {% include "partials/requirement_card.html" %}
        {% endwith %}
        {% else %}
        {# Future steps â€” compact locked row #}
        <div class="flex items-center gap-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 px-4 py-2.5 opacity-50">
            <span class="text-gray-400 dark:text-gray-500">â—‹</span>
            <span class="text-sm text-gray-500 dark:text-gray-400">{{ req.name }}</span>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}
{% endblock %}
