"""CTF Token Verification for Linux CTF Challenge.

This module verifies CTF completion tokens generated by the Linux CTF challenges.
The verification process ensures:
1. Token is properly signed with HMAC
2. GitHub username in the token matches the authenticated user
3. All 18 challenges are completed
4. Timestamp is valid
"""

import base64
import hashlib
import hmac
import json
import logging
from dataclasses import dataclass
from datetime import datetime

from core.config import get_settings

logger = logging.getLogger(__name__)

REQUIRED_CHALLENGES = 18


def _get_master_secret() -> str:
    """Get the CTF master secret from settings."""
    settings = get_settings()
    secret = settings.ctf_master_secret
    if settings.environment.lower() == "production" and (
        not secret or secret == "L2C_CTF_MASTER_2024"
    ):
        raise RuntimeError("CTF master secret is not configured")
    return secret


def _derive_secret(instance_id: str) -> str:
    """Derive the verification secret from master secret and instance ID."""
    master_secret = _get_master_secret()
    data = f"{master_secret}:{instance_id}"
    return hashlib.sha256(data.encode()).hexdigest()


@dataclass
class CTFVerificationResult:
    """Result of CTF token verification."""

    is_valid: bool
    message: str
    github_username: str | None = None
    completion_date: str | None = None
    completion_time: str | None = None
    challenges_completed: int | None = None


def verify_ctf_token(token: str, oauth_github_username: str) -> CTFVerificationResult:
    """
    Verify a CTF completion token.

    Args:
        token: The base64-encoded token from the user
        oauth_github_username: The GitHub username from OAuth sign-in

    Returns:
        CTFVerificationResult with verification status and data
    """
    try:
        try:
            decoded = base64.b64decode(token).decode("utf-8")
            token_data = json.loads(decoded)
        except (ValueError, json.JSONDecodeError) as e:
            logger.warning(f"CTF token decode failed: {e}")
            return CTFVerificationResult(
                is_valid=False,
                message="Invalid token format. Could not decode the token.",
            )

        payload = token_data.get("payload")
        signature = token_data.get("signature")

        if not payload or not signature:
            return CTFVerificationResult(
                is_valid=False,
                message="Invalid token structure. Missing payload or signature.",
            )

        token_username = (payload.get("github_username") or "").lower()
        oauth_username_lower = oauth_github_username.lower()

        if token_username != oauth_username_lower:
            logger.warning(
                "CTF username mismatch: token='%s', oauth='%s'",
                token_username,
                oauth_username_lower,
            )
            return CTFVerificationResult(
                is_valid=False,
                message=(
                    f"GitHub username mismatch. "
                    f"Token is for '{payload.get('github_username')}', "
                    f"but you signed in as '{oauth_github_username}'."
                ),
            )

        instance_id = payload.get("instance_id")
        if not instance_id:
            return CTFVerificationResult(
                is_valid=False,
                message="Invalid token: missing instance ID.",
            )

        try:
            verification_secret = _derive_secret(instance_id)
        except RuntimeError:
            logger.exception("CTF verification misconfigured")
            return CTFVerificationResult(
                is_valid=False,
                message="CTF verification is not available right now.",
            )

        payload_str = json.dumps(payload, separators=(",", ":"))

        expected_sig = hmac.new(
            verification_secret.encode(),
            payload_str.encode(),
            hashlib.sha256,
        ).hexdigest()

        if not hmac.compare_digest(signature, expected_sig):
            logger.warning("CTF token signature verification failed")
            return CTFVerificationResult(
                is_valid=False,
                message=(
                    "Invalid token signature. The token may have been tampered with."
                ),
            )

        challenges = payload.get("challenges", 0)
        if challenges != REQUIRED_CHALLENGES:
            return CTFVerificationResult(
                is_valid=False,
                message=(
                    f"Incomplete challenges: {challenges}/{REQUIRED_CHALLENGES}. "
                    "Complete all challenges to get a valid token."
                ),
            )

        timestamp = payload.get("timestamp", 0)
        now = datetime.now().timestamp()
        if timestamp > now + 3600:
            return CTFVerificationResult(
                is_valid=False,
                message="Invalid timestamp. The token appears to be from the future.",
            )

        logger.info(
            f"CTF token verified for user '{oauth_github_username}' "
            f"with {challenges} challenges"
        )

        return CTFVerificationResult(
            is_valid=True,
            message=(
                f"ðŸŽ‰ Congratulations! You have completed all {REQUIRED_CHALLENGES} "
                "Linux CTF challenges!"
            ),
            github_username=payload.get("github_username"),
            completion_date=payload.get("date"),
            completion_time=payload.get("time"),
            challenges_completed=challenges,
        )

    except Exception as e:
        logger.exception(f"CTF token verification error: {e}")
        return CTFVerificationResult(
            is_valid=False,
            message=f"Token verification failed: {str(e)}",
        )
